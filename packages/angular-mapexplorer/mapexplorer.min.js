"use strict";function stMapExplorer(debounce){function load(scope){StratumnSDK.getApplication(scope.application).then(function(app){return app.getMap(scope.mapId)}).then(function(res){return Promise.all(res.map(function(link){return link.load()}))}).then(function(res){var root=parse(scope,res);root.x0=height/2,root.y0=0,update(scope,root)})}function parse(scope,chainMap){return chainMap.forEach(function(segment){scope.segmentsByHash[segment.meta.linkHash]||(segment.link.meta.prevLinkHash||(scope.root=segment),scope.segmentsByHash[segment.meta.linkHash]=segment)}),scope.root||(scope.root=chainMap[0]),chainMap.forEach(function(segment){if(segment.link.meta.prevLinkHash){var parent=scope.segmentsByHash[segment.link.meta.prevLinkHash];if(!parent)throw"Missing parent with linkHash "+segment.meta.linkHash;parent.children=parent.children||[],["children","_children"].forEach(function(meth){parent[meth]&&!parent[meth].find(function(elt){return elt.meta.linkHash===segment.meta.linkHash})&&parent[meth].push(segment)})}}),scope.root}function translate(x,y){return"translate("+y+","+x+")"}function update(scope,source){function click(d){d.children?(d._children=d.children,d.children=null):(d.children=d._children,d._children=null),update(scope,d)}var nodes=scope.tree.nodes(scope.root).reverse(),links=scope.tree.links(nodes);nodes.forEach(function(d){d.y=Math.min(100*d.depth,d.y)});var node=scope.svg.selectAll("g.node").data(nodes,function(d){return d.id||(d.id=++scope.i)}),nodeEnter=node.enter().append("g").attr("class",function(d){return["node"].concat(d.link.meta.tags).join(" ")}).attr("transform",function(d){var origin=d.parent&&d.parent.x0?d.parent:source;return translate(origin.x0,origin.y0)}).on("click",click);nodeEnter.append("circle").attr("r",1e-6),nodeEnter.append("text").attr("x",0).attr("dy","-1em").attr("text-anchor","middle").text(scope.options.getSegmentText).style("fill-opacity",1e-6);var nodeUpdate=node.transition().duration(scope.options.duration).attr("transform",function(d){return translate(d.x,d.y)});nodeUpdate.select("circle").attr("r",4.5),nodeUpdate.select("text").style("fill-opacity",1);var nodeExit=node.exit().transition().duration(scope.options.duration).attr("transform",function(){return translate(source.x,source.y)}).remove();nodeExit.select("circle").attr("r",1e-6),nodeExit.select("text").style("fill-opacity",1e-6);var link=scope.svg.selectAll("path.link").data(links,function(d){return d.target.id});link.enter().insert("text").attr("x",40).attr("dy","-0.5em").append("textPath").attr("class","textpath").attr("xlink:href",function(d){return"#"+d.target.id}).text(scope.options.getLinkText),link.enter().insert("path","g").attr("class","link").attr("id",function(d){return d.target.id}).attr("d",function(d){var o=d.source&&d.source.x0?{x:d.source.x0,y:d.source.y0}:{x:source.x0,y:source.y0};return scope.diagonal({source:o,target:o})}),link.transition().duration(scope.options.duration).attr("d",scope.diagonal),link.exit().transition().duration(scope.options.duration).attr("d",function(d){var o={x:source.x,y:source.y};return scope.diagonal({source:o,target:o})}).remove(),nodes.forEach(function(d){d.x0=d.x,d.y0=d.y})}var margin={top:20,right:120,bottom:20,left:120},width=1680-margin.right-margin.left,height=800-margin.top-margin.bottom,defaultOptions={withArgs:!1,getSegmentText:function(node){return node.meta.linkHash.slice(0,3)+"..."+node.meta.linkHash.slice(61)},getLinkText:function(node){return node.target.link.meta.action+(this.withArgs?"("+node.target.link.meta.arguments.join(", ")+")":"")},duration:750};return{restrict:"E",scope:{application:"=",mapId:"=",refresh:"=",options:"=?"},template:"<svg></svg>",link:function(scope,element){console.log(scope),scope.options=angular.isDefined(scope.options)?scope.options:{},scope.options=Object.assign({},defaultOptions,scope.options),scope.i=0,scope.root=null,scope.segmentsByHash={},scope.tree=d3.layout.tree().size([height,width]),scope.diagonal=d3.svg.diagonal().projection(function(d){return[d.y,d.x]}),scope.svg=d3.select(element.find("svg")[0]).attr("width",width+margin.right+margin.left).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")");var fn=debounce(100,load,!0);scope.$watchGroup(["application","mapId","refresh"],function(){scope.mapId&&fn(scope)})}}}angular.module("stratumn.angular-mapexplorer",["rt.debounce"]).directive("stMapExplorer",stMapExplorer),stMapExplorer.$inject=["debounce"];